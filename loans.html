<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Multi-Loan Payment Estimator | PWA Loan Calculator</title>
    <meta name="description" content="A powerful, offline-first PWA to manage multiple student loans. Features amortization schedules, lumpsum payments, and persistent storage.">
    <meta name="keywords" content="student loan calculator, loan amortization, debt payoff planner, pwa, financial tool, loan dashboard, interest calculator">
    <meta name="author" content="Your Name or Company">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4f46e5"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            position: relative;
        }
        .input-group span {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .input-group input {
            padding-left: 28px;
        }
        .tab {
            cursor: pointer;
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            position: relative;
            padding-right: 80px; /* Space for action buttons */
        }
        .tab.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .tab:hover:not(.active) {
            background-color: #f3f4f6; /* gray-100 */
        }
        .tab-name {
            outline: none;
        }
        .tab-name[contenteditable="true"] {
            background-color: #e0e7ff; /* indigo-100 */
            padding: 2px 4px;
            border-radius: 4px;
        }
        .tab-actions {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            display: none;
            gap: 6px;
            align-items: center;
        }
        .tab:hover .tab-actions {
            display: flex;
        }
        .tab-action-btn {
            color: #9ca3af;
            cursor: pointer;
            border-radius: 9999px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-action-btn:hover {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .lumpsum-row td {
            background-color: #eff6ff; /* blue-50 */
        }
        /* Lumpsum Add/Below Buttons */
        tr[data-type="monthly"] td {
            position: relative; /* Container for the buttons */
        }
        .lumpsum-btn {
            position: absolute;
            display: none; /* Hide by default */
            left: 50%;
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
            white-space: nowrap;
        }
        .lumpsum-btn:hover {
            background-color: #4338ca;
        }
        .lumpsum-btn:disabled {
            background-color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .desktop-device tr[data-type="monthly"] td:hover .lumpsum-btn {
            display: block; 
        }
        .touch-device tr[data-type="monthly"].lumpsum-active td .lumpsum-btn {
            display: block;
        }
        .lumpsum-above {
            top: 0;
            transform: translate(-50%, -50%);
        }
        .lumpsum-below {
            bottom: 0;
            transform: translate(-50%, 50%);
        }
        /* Delete Lumpsum button styling */
        .delete-lumpsum-btn {
            display: block; /* Always visible */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #dc2626; /* red-600 */
            color: white;
            border: none;
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
            opacity: 0.8;
        }
        .delete-lumpsum-btn:hover {
             background-color: #b91c1c; /* red-700 */
             opacity: 1;
        }
        /* Highlight Styles */
        .highlight-extra-emi td {
            background-color: #fef9c3; /* yellow-100 */
        }
        .highlight-hike td {
             background-color: #dcfce7; /* green-100 */
        }
        /* Clipboard Message */
        #clipboard-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #clipboard-message.show {
            opacity: 1;
        }
        /* Confirmation Modal */
        #confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }
        #confirmation-modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Multi-Loan Payment Estimator</h1>
            <p class="mt-2 text-md text-gray-600">Manage multiple loan schedules. All your data is saved automatically in your browser.</p>
        </header>

        <!-- Tabs Section -->
        <div class="border-b border-gray-200 mb-8">
            <div id="tabs-container" class="flex items-center space-x-2 overflow-x-auto pb-2">
                <!-- Tabs will be dynamically inserted here -->
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Loan Amount, APR, Term Inputs -->
                <div>
                    <label for="loanAmount" class="block text-sm font-medium text-gray-700 mb-1">Loan Amount</label>
                    <div class="input-group">
                        <span id="loan-amount-currency-symbol">$</span>
                        <input type="number" id="loanAmount" value="30000" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label for="apr" class="block text-sm font-medium text-gray-700 mb-1">Annual Interest Rate (APR)</label>
                    <div class="relative">
                        <input type="number" id="apr" value="5.5" step="0.01" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pr-8 px-3">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">%</span>
                    </div>
                </div>
                <div>
                    <label for="loanTerm" class="block text-sm font-medium text-gray-700 mb-1">Loan Term (Years)</label>
                    <input type="number" id="loanTerm" value="10" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 px-3">
                </div>
            </div>
             <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pb-6 mb-6 border-b border-gray-200">
                <button id="calculateBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">
                    Calculate
                </button>
                <button id="downloadBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">
                    Download csv
                </button>
                <button id="shareBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">
                    Share
                </button>
            </div>
            <!-- Advanced Payoff Strategy Section -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Advanced Payoff Strategy</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="extraPaymentsPerYear" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                            <span class="inline-block w-3 h-3 bg-yellow-100 border border-yellow-300 rounded-sm mr-2"></span>
                            <span>Number of Extra Payments in a Year</span>
                        </label>
                        <input type="number" id="extraPaymentsPerYear" min="0" value="0" placeholder="e.g., 1" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 px-3">
                    </div>
                    <div>
                        <label for="annualHikePercent" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                            <span class="inline-block w-3 h-3 bg-green-100 border border-green-300 rounded-sm mr-2"></span>
                            <span>Hike Payment by % Every Year</span>
                        </label>
                        <div class="relative">
                            <input type="number" id="annualHikePercent" min="0" value="0" class="w-full bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 pr-8 px-3">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary Section -->
        <div id="summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 text-center">
            <div class="bg-white p-4 rounded-xl shadow">
                <h3 class="text-sm font-medium text-gray-500">Minimum Monthly Payment</h3>
                <p id="monthlyPayment" class="text-2xl font-semibold text-indigo-600">-</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow">
                <h3 class="text-sm font-medium text-gray-500">Total Interest Paid</h3>
                <div id="totalInterest" class="text-2xl font-semibold text-indigo-600">-</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow">
                <h3 class="text-sm font-medium text-gray-500">Payoff Date & Savings</h3>
                <div id="payoff-summary" class="text-2xl font-semibold text-gray-600">-</div>
            </div>
        </div>

        <!-- Amortization Table -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beginning Balance</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min. Payment</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Additional/Lumpsum</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Payment</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interest</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Principal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ending Balance</th>
                        </tr>
                    </thead>
                    <tbody id="amortization-body" class="bg-white divide-y divide-gray-200">
                         <tr><td colspan="9" class="text-center p-8 text-gray-500">Add a tab and enter loan details to get started.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Clipboard Message -->
    <div id="clipboard-message">Link copied to clipboard!</div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden flex">
        <div id="confirmation-modal-content">
            <h3 class="text-lg font-bold mb-2">Reset Payoff Strategy?</h3>
            <p class="text-sm text-gray-700 mb-6">This will clear all lumpsum, recurring, and advanced payments for this loan. Are you sure you want to continue?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Yes, Reset</button>
            </div>
        </div>
    </div>

    <script>
        // --- SEO & AI Search Tools ---
        const setupSEOTools = () => {
            if (location.pathname === '/sitemap.xml') {
                const sitemapContent = `<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"><url><loc>${location.origin}${location.pathname.replace('sitemap.xml', '')}</loc><lastmod>${new Date().toISOString()}</lastmod><priority>1.00</priority></url></urlset>`;
                document.open();
                document.write('<pre style="word-wrap: break-word; white-space: pre-wrap;">' + sitemapContent.replace(/</g, '&lt;') + '</pre>');
                document.close();
                return true;
            }
            if (location.pathname === '/robots.txt') {
                const robotsContent = `User-agent: *\nAllow: /\nSitemap: ${location.origin}/sitemap.xml`;
                document.open();
                document.write('<pre style="word-wrap: break-word; white-space: pre-wrap;">' + robotsContent + '</pre>');
                document.close();
                return true;
            }
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.textContent = JSON.stringify({
                "@context": "https://schema.org", "@type": "WebPage", "name": "Multi-Loan Payment Estimator | PWA Loan Calculator",
                "description": "A powerful, offline-first PWA to manage multiple student loans, featuring amortization schedules, lumpsum payments, and persistent storage.",
                "url": location.href,
                "mainEntity": {
                    "@type": "FinancialProduct", "name": "Student Loan Amortization Calculator",
                    "description": "Calculate and manage multiple loan payments with detailed amortization schedules, lumpsum payment modeling, and persistent local storage.",
                    "provider": { "@type": "Organization", "name": "Financial Tools" }
                }
            });
            document.head.appendChild(script);
            return false;
        };
        
        if (setupSEOTools()) {
            // Stop execution if sitemap or robots was generated
        } else {
            // --- PWA Setup ---
            const setupPWA = () => {
                const manifest = {
                    "name": "Multi-Loan Payment Estimator", "short_name": "LoanCalc", "start_url": ".", "display": "standalone", "background_color": "#f9fafb", "theme_color": "#4f46e5", "description": "A powerful, offline-first student loan calculator with tabs.",
                    "icons": [{"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgcng9IjM4LjQiIGZpbGw9IiM0ZjQ2ZTUiLz48dGV4dCB4PSI5NiIgeT0iMTM1IiBmb250LXNpemU9IjEwMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaGyPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiPiQ8L3RleHQ+PC9zdmc+", "sizes": "192x192", "type": "image/svg+xml"}, {"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMi40IiBmaWxsPSIjNGY0NmU1IiLz48dGV4dCB4PSIyNTYiIHk9IjM2NSIgZm9udC1zaXplPSIyODAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSJib2xkIj4kPC90ZXh0Pjwvc3ZnPg==", "sizes": "512x512", "type": "image/svg+xml"}]
                };
                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);
                const linkEl = document.createElement('link');
                linkEl.rel = 'manifest';
                linkEl.href = manifestUrl;
                document.head.appendChild(linkEl);
                if ('serviceWorker' in navigator) {
                    const swContent = `const CACHE_NAME = 'loan-calculator-cache-v1'; const urlsToCache = ['${location.href}']; self.addEventListener('install', event => { event.waitUntil( caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)) ); }); self.addEventListener('fetch', event => { event.respondWith( caches.match(event.request).then(response => response || fetch(event.request)) ); });`;
                    const swBlob = new Blob([swContent], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registered!', reg)).catch(err => console.log('SW registration failed: ', err));
                }
            };

            // --- DOM Element References ---
            const loanAmountEl = document.getElementById('loanAmount');
            const aprEl = document.getElementById('apr');
            const loanTermEl = document.getElementById('loanTerm');
            const calculateBtn = document.getElementById('calculateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const shareBtn = document.getElementById('shareBtn');
            const amortizationBody = document.getElementById('amortization-body');
            const summaryEl = document.getElementById('summary');
            const monthlyPaymentEl = document.getElementById('monthlyPayment');
            const totalInterestEl = document.getElementById('totalInterest');
            const payoffSummaryEl = document.getElementById('payoff-summary');
            const tabsContainer = document.getElementById('tabs-container');
            const loanAmountCurrencySymbolEl = document.getElementById('loan-amount-currency-symbol');
            const extraPaymentsPerYearEl = document.getElementById('extraPaymentsPerYear');
            const annualHikePercentEl = document.getElementById('annualHikePercent');
            const clipboardMessageEl = document.getElementById('clipboard-message');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            // --- Currency Management ---
            let userCurrency = 'USD';

            async function getUserCurrency() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    if (!response.ok) throw new Error('API response not OK');
                    const data = await response.json();
                    return data.currency || 'USD';
                } catch (error) {
                    console.error('Could not fetch currency, defaulting to USD:', error);
                    return 'USD';
                }
            }

            const formatCurrency = (num) => {
                return new Intl.NumberFormat(undefined, { 
                    style: 'currency', 
                    currency: userCurrency 
                }).format(num);
            };

            // --- State Management ---
            let state = {
                tabs: [],
                activeTabId: null
            };

            const saveState = () => {
                localStorage.setItem('loanCalculatorState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('loanCalculatorState');
                if (savedState) {
                    state = JSON.parse(savedState);
                } else {
                    addTab(false);
                }
            };

            const getActiveTabData = () => {
                return state.tabs.find(tab => tab.id === state.activeTabId);
            };

            // --- Tab Management ---
            const renderTabs = () => {
                tabsContainer.innerHTML = '';
                state.tabs.forEach(tab => {
                    const tabEl = document.createElement('div');
                    tabEl.className = `tab ${tab.id === state.activeTabId ? 'active' : ''}`;
                    tabEl.dataset.tabId = tab.id;
                    tabEl.innerHTML = `
                        <span class="tab-name" contenteditable="false">${tab.name}</span>
                        <div class="tab-actions">
                            <div class="tab-action-btn share-btn" onclick="event.stopPropagation(); shareTab(${tab.id});">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                            </div>
                            <div class="tab-action-btn rename-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </div>
                            <div class="tab-action-btn delete-tab-btn" onclick="event.stopPropagation(); deleteTab(${tab.id});">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </div>
                        </div>`;
                    tabsContainer.appendChild(tabEl);
                });

                const addBtn = document.createElement('button');
                addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 hover:text-indigo-600"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>`;
                addBtn.className = 'ml-2';
                addBtn.onclick = () => addTab(true);
                tabsContainer.appendChild(addBtn);
            };

            function addTab(shouldSave = true, tabData = null) {
                const newTab = tabData ? { ...tabData, id: Date.now() } : {
                    id: Date.now(),
                    name: `Loan ${state.tabs.length + 1}`,
                    amount: 30000,
                    apr: 5.5,
                    term: 10,
                    additionalPayments: {},
                    lumpsums: [],
                    extraPaymentsPerYear: 0,
                    annualHikePercent: 0,
                    originalTotalInterest: null
                };
                state.tabs.push(newTab);
                state.activeTabId = newTab.id;
                if (shouldSave) saveState();
                renderTabs();
                loadActiveTabDataIntoUI();
            }

            function deleteTab(tabId) {
                const tabIndex = state.tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;
                state.tabs.splice(tabIndex, 1);
                if (state.activeTabId === tabId) {
                    if (state.tabs.length > 0) {
                        const newActiveIndex = Math.max(0, tabIndex - 1);
                        state.activeTabId = state.tabs[newActiveIndex].id;
                    } else {
                        addTab(false);
                    }
                }
                saveState();
                renderTabs();
                loadActiveTabDataIntoUI();
            }

            function switchTab(tabId) {
                state.activeTabId = tabId;
                saveState();
                renderTabs();
                loadActiveTabDataIntoUI();
            }
            
            function renameTab(tabId, newName) {
                const tab = state.tabs.find(t => t.id === tabId);
                if(tab && newName) {
                    tab.name = newName;
                    saveState();
                }
            }
            
            function startRename(tabEl) {
                const tabNameEl = tabEl.querySelector('.tab-name');
                if (tabNameEl) {
                    tabNameEl.contentEditable = true;
                    tabNameEl.focus();
                    document.execCommand('selectAll', false, null);
                }
            }

            function loadActiveTabDataIntoUI() {
                const activeTab = getActiveTabData();
                if (!activeTab) {
                    amortizationBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-500">Add a tab to get started.</td></tr>`;
                    return;
                }
                loanAmountEl.value = activeTab.amount;
                aprEl.value = activeTab.apr;
                loanTermEl.value = activeTab.term;
                extraPaymentsPerYearEl.value = activeTab.extraPaymentsPerYear || 0;
                annualHikePercentEl.value = activeTab.annualHikePercent || 0;
                generateSchedule(false);
            }

            // --- Shareable Link Logic ---
            function shareTab(tabId) {
                const tabData = state.tabs.find(t => t.id === tabId);
                if (!tabData) return;
                const dataToShare = { ...tabData };
                delete dataToShare.id;
                const jsonString = JSON.stringify(dataToShare);
                const compressedToken = LZString.compressToEncodedURIComponent(jsonString);
                const shareUrl = new URL(window.location.href);
                shareUrl.searchParams.set('loan', compressedToken);
                const dummy = document.createElement('textarea');
                document.body.appendChild(dummy);
                dummy.value = shareUrl.href;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                clipboardMessageEl.classList.add('show');
                setTimeout(() => {
                    clipboardMessageEl.classList.remove('show');
                }, 2000);
            }

            function loadFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const loanDataToken = urlParams.get('loan');
                if (loanDataToken) {
                    try {
                        const jsonString = LZString.decompressFromEncodedURIComponent(loanDataToken);
                        const sharedTabData = JSON.parse(jsonString);
                        sharedTabData.name = "Imported Loan";
                        addTab(true, sharedTabData);
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        console.error("Failed to decode shared loan data:", error);
                    }
                }
            }

            // --- Lumpsum & Payment Management ---
            function addLumpsum(afterMonth) {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                const newLumpsum = { id: Date.now(), afterMonth: afterMonth, amount: 1000 };
                activeTab.lumpsums.push(newLumpsum);
                activeTab.lumpsums.sort((a, b) => a.afterMonth - b.afterMonth);
                generateSchedule(false);
            }
            
            function deleteLumpsum(id) {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                activeTab.lumpsums = activeTab.lumpsums.filter(l => l.id !== id);
                generateSchedule(false);
            }

            function updateLumpsum(id, amount) {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                const lumpsum = activeTab.lumpsums.find(l => l.id === id);
                if (lumpsum) {
                    lumpsum.amount = amount;
                    generateSchedule(false);
                }
            }
            
            function updateAdditionalPayment(month, amount) {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                for (let m = month; m <= activeTab.term * 12; m++) {
                    activeTab.additionalPayments[m] = amount;
                }
                generateSchedule(false);
            }

            // --- Core Calculation & Rendering Logic ---
            function calculateMonthlyPayment(p, i, n) {
                if (i === 0) return p / n;
                return p * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
            }

            function generateSchedule(resetBaseline = false) {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                
                if (resetBaseline) {
                    activeTab.amount = parseFloat(loanAmountEl.value);
                    activeTab.apr = parseFloat(aprEl.value);
                    activeTab.term = parseInt(loanTermEl.value);
                }
                activeTab.extraPaymentsPerYear = parseInt(extraPaymentsPerYearEl.value) || 0;
                activeTab.annualHikePercent = parseFloat(annualHikePercentEl.value) || 0;

                const { amount: principal, apr, term: years, extraPaymentsPerYear, annualHikePercent } = activeTab;
                if (isNaN(principal) || isNaN(apr) || isNaN(years) || principal <= 0 || apr < 0 || years <= 0) {
                    amortizationBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-red-500">Please enter valid loan details.</td></tr>`;
                    return;
                }
                const monthlyInterestRate = apr / 100 / 12;
                const numberOfMonths = years * 12;
                const baseMonthlyPayment = calculateMonthlyPayment(principal, monthlyInterestRate, numberOfMonths);
                let currentMonthlyPayment = baseMonthlyPayment;
                monthlyPaymentEl.textContent = formatCurrency(baseMonthlyPayment);
                let currentBalance = principal;
                let totalInterestPaid = 0;
                let tableHTML = '';
                let paymentDate = new Date();
                paymentDate.setDate(1);
                let lumpsumIndex = 0;
                let visibleMonths = 0;
                for (let month = 1; month <= numberOfMonths && currentBalance > 0.01; month++) {
                    let highlightClass = '';
                    if (annualHikePercent > 0 && month > 1 && (month - 1) % 12 === 0) {
                        currentMonthlyPayment *= (1 + annualHikePercent / 100);
                        highlightClass = 'highlight-hike';
                    }
                    while(lumpsumIndex < activeTab.lumpsums.length && activeTab.lumpsums[lumpsumIndex].afterMonth === month - 1) {
                        const lumpsum = activeTab.lumpsums[lumpsumIndex];
                        const lumpsumAmount = Math.min(currentBalance, lumpsum.amount);
                        const endingBalanceLumpsum = currentBalance - lumpsumAmount;
                        tableHTML += createLumpsumRowHTML(lumpsum, currentBalance, paymentDate, lumpsumAmount, endingBalanceLumpsum);
                        currentBalance = endingBalanceLumpsum;
                        lumpsumIndex++;
                    }
                    if (currentBalance < 0.01) break;
                    paymentDate.setMonth(paymentDate.getMonth() + 1);
                    const formattedDate = paymentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric'});
                    const interestForMonth = currentBalance * monthlyInterestRate;
                    let finalAdditionalPayment = activeTab.additionalPayments[month] || 0;
                    if (extraPaymentsPerYear > 0 && month % 12 === 0) {
                        finalAdditionalPayment += currentMonthlyPayment * extraPaymentsPerYear;
                        highlightClass = 'highlight-extra-emi';
                    }
                    const totalMonthlyPayment = currentMonthlyPayment + finalAdditionalPayment;
                    const principalPaid = Math.min(currentBalance, totalMonthlyPayment - interestForMonth);
                    const actualTotalPayment = principalPaid + interestForMonth;
                    const endingBalance = currentBalance - principalPaid;
                    totalInterestPaid += interestForMonth;
                    tableHTML += createMonthlyRowHTML(activeTab, month, formattedDate, currentBalance, currentMonthlyPayment, finalAdditionalPayment, actualTotalPayment, interestForMonth, principalPaid, endingBalance, highlightClass);
                    currentBalance = endingBalance;
                    visibleMonths++;
                }
                
                if (resetBaseline) {
                    activeTab.originalTotalInterest = totalInterestPaid;
                }

                amortizationBody.innerHTML = tableHTML || `<tr><td colspan="9" class="text-center p-8 text-gray-500">Loan is fully paid.</td></tr>`;
                updateSummary(totalInterestPaid, numberOfMonths, visibleMonths);

                saveState();
                attachRowEventListeners();
            }
            
            function updateSummary(newInterest, originalMonths, newMonths) {
                const activeTab = getActiveTabData();
                const originalInterest = activeTab.originalTotalInterest;

                // Update Interest Paid card
                if (originalInterest && Math.abs(newInterest - originalInterest) > 0.01) {
                    totalInterestEl.innerHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-lg text-gray-500 line-through">${formatCurrency(originalInterest)}</span>
                            <span class="text-2xl font-semibold text-green-600">${formatCurrency(newInterest)}</span>
                        </div>
                    `;
                } else {
                    totalInterestEl.innerHTML = `<p class="text-2xl font-semibold text-indigo-600">${formatCurrency(newInterest)}</p>`;
                }

                // Update Payoff Date card
                const originalPayoffDate = new Date();
                originalPayoffDate.setDate(1);
                originalPayoffDate.setMonth(originalPayoffDate.getMonth() + originalMonths);
                const formattedOriginalDate = originalPayoffDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

                const newPayoffDate = new Date();
                newPayoffDate.setDate(1);
                newPayoffDate.setMonth(newPayoffDate.getMonth() + newMonths);
                const formattedNewDate = newPayoffDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

                if (originalInterest && newMonths < originalMonths) {
                    const interestSaved = originalInterest - newInterest;
                    const monthsSaved = originalMonths - newMonths;
                    payoffSummaryEl.innerHTML = `
                        <div>
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-lg text-gray-500 line-through">${formattedOriginalDate}</span>
                                <span class="text-2xl font-semibold text-green-600">${formattedNewDate}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                (Saving ${formatCurrency(interestSaved)} & ${monthsSaved} months)
                            </p>
                        </div>
                    `;
                } else {
                     payoffSummaryEl.innerHTML = `<p class="text-2xl font-semibold text-gray-600">${formattedOriginalDate}</p>`;
                }
            }

            function createMonthlyRowHTML(activeTab, month, date, balance, minPay, addPay, totalPay, interest, principal, endBalance, highlightClass) {
                const lumpsumAboveExists = activeTab.lumpsums.some(l => l.afterMonth === month - 1);
                const lumpsumBelowExists = activeTab.lumpsums.some(l => l.afterMonth === month);
                const currencySymbol = formatCurrency(0).replace(/[\d\.\s,]/g, '');
                const lumpsumButtonsHTML = `<button class="lumpsum-btn lumpsum-above" onclick="addLumpsum(${month - 1})" ${lumpsumAboveExists ? 'disabled' : ''}>Add Lumpsum</button><button class="lumpsum-btn lumpsum-below" onclick="addLumpsum(${month})" ${lumpsumBelowExists ? 'disabled' : ''}>Add Lumpsum</button>`;
                const createCell = (content) => `<td class="px-6 py-4 whitespace-nowrap text-sm relative">${content}${lumpsumButtonsHTML}</td>`;
                return `<tr data-month="${month}" data-type="monthly" class="${highlightClass}">
                        ${createCell(`<span class="text-gray-500">${month}</span>`)}
                        ${createCell(`<span class="text-gray-500">${date}</span>`)}
                        ${createCell(`<span class="text-gray-900">${formatCurrency(balance)}</span>`)}
                        ${createCell(`<span class="text-gray-900">${formatCurrency(minPay)}</span>`)}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 relative">
                            <div class="input-group"><span>${currencySymbol}</span><input type="number" min="0" step="10" value="${addPay}" class="additional-payment-input w-24 bg-gray-100 border-gray-300 rounded-md shadow-sm"></div>
                            ${lumpsumButtonsHTML}
                        </td>
                        ${createCell(`<span class="font-medium text-gray-900">${formatCurrency(totalPay)}</span>`)}
                        ${createCell(`<span class="text-gray-900">${formatCurrency(interest)}</span>`)}
                        ${createCell(`<span class="text-gray-900">${formatCurrency(principal)}</span>`)}
                        ${createCell(`<span class="font-semibold text-indigo-700">${formatCurrency(endBalance)}</span>`)}
                    </tr>`;
            }

            function createLumpsumRowHTML(lumpsum, balance, date, amount, endBalance) {
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric'});
                const currencySymbol = formatCurrency(0).replace(/[\d\.\s,]/g, '');
                return `<tr data-lumpsum-id="${lumpsum.id}" data-type="lumpsum" class="lumpsum-row">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-800">Lumpsum</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(balance)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 relative">-<button class="delete-lumpsum-btn" onclick="deleteLumpsum(${lumpsum.id})">Delete</button></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><div class="input-group"><span>${currencySymbol}</span><input type="number" min="0" step="10" value="${amount}" class="lumpsum-payment-input w-24 bg-blue-100 border-blue-300 rounded-md shadow-sm"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCurrency(amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-indigo-700">${formatCurrency(endBalance)}</td>
                    </tr>`;
            }

            function downloadAsExcel() {
                const activeTab = getActiveTabData();
                if (!activeTab) return;
                const table = document.querySelector('table');
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                let csvContent = headers.join(',') + '\n';
                Array.from(amortizationBody.querySelectorAll('tr')).forEach(row => {
                    const cells = Array.from(row.querySelectorAll('td'));
                    const rowData = cells.map((cell, index) => {
                        let cellText = cell.textContent.replace(/[\$,]/g, '').trim();
                        if (index === 4) { cellText = cell.querySelector('input')?.value || '0'; }
                        return `"${cellText}"`;
                    });
                    csvContent += rowData.join(',') + '\n';
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${activeTab.name.replace(/ /g, '_')}_schedule.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- Confirmation Modal Logic ---
            function showConfirmationModal() {
                confirmationModal.classList.remove('hidden');
            }
            function hideConfirmationModal() {
                confirmationModal.classList.add('hidden');
            }
            function hasActiveStrategies(tab) {
                return tab.extraPaymentsPerYear > 0 || 
                       tab.annualHikePercent > 0 || 
                       tab.lumpsums.length > 0 || 
                       Object.values(tab.additionalPayments).some(p => p > 0);
            }
            function resetStrategies(tab) {
                tab.extraPaymentsPerYear = 0;
                tab.annualHikePercent = 0;
                tab.lumpsums = [];
                tab.additionalPayments = {};
                extraPaymentsPerYearEl.value = 0;
                annualHikePercentEl.value = 0;
            }

            // --- Event Listeners ---
            function attachRowEventListeners() {
                document.querySelectorAll('.additional-payment-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const month = parseInt(e.target.closest('tr').dataset.month);
                        const amount = parseFloat(e.target.value) || 0;
                        updateAdditionalPayment(month, amount);
                    });
                });
                document.querySelectorAll('.lumpsum-payment-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const id = parseInt(e.target.closest('tr').dataset.lumpsumId);
                        const amount = parseFloat(e.target.value) || 0;
                        updateLumpsum(id, amount);
                    });
                });
            }

            calculateBtn.addEventListener('click', () => {
                const activeTab = getActiveTabData();
                if (hasActiveStrategies(activeTab)) {
                    showConfirmationModal();
                } else {
                    resetStrategies(activeTab);
                    generateSchedule(true);
                }
            });
            confirmResetBtn.addEventListener('click', () => {
                const activeTab = getActiveTabData();
                resetStrategies(activeTab);
                generateSchedule(true);
                hideConfirmationModal();
            });
            confirmCancelBtn.addEventListener('click', hideConfirmationModal);

            downloadBtn.addEventListener('click', downloadAsExcel);
            shareBtn.addEventListener('click', () => {
                const activeTab = getActiveTabData();
                if (activeTab) {
                    shareTab(activeTab.id);
                }
            });
            extraPaymentsPerYearEl.addEventListener('change', () => generateSchedule(false));
            annualHikePercentEl.addEventListener('change', () => generateSchedule(false));
            
            tabsContainer.addEventListener('click', (e) => {
                const tabEl = e.target.closest('.tab');
                if (!tabEl) return;
                const renameBtn = e.target.closest('.rename-btn');
                if (renameBtn) { e.stopPropagation(); startRename(tabEl); return; }
                if (e.target.closest('.delete-tab-btn')) { e.stopPropagation(); return; }
                if (e.target.closest('.share-btn')) { e.stopPropagation(); return; }
                switchTab(Number(tabEl.dataset.tabId));
            });

            tabsContainer.addEventListener('blur', (e) => {
                const tabNameEl = e.target.closest('.tab-name');
                if (tabNameEl && tabNameEl.contentEditable === 'true') {
                    tabNameEl.contentEditable = false;
                    const tabId = Number(e.target.closest('.tab').dataset.tabId);
                    renameTab(tabId, tabNameEl.textContent.trim());
                }
            }, true);

            tabsContainer.addEventListener('keydown', (e) => {
                const tabNameEl = e.target.closest('.tab-name');
                if (tabNameEl && tabNameEl.contentEditable === 'true' && e.key === 'Enter') {
                    e.preventDefault();
                    tabNameEl.blur();
                }
            });

            // --- Mobile/Touch specific event handling ---
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isTouchDevice) {
                document.body.classList.add('touch-device');
                amortizationBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr[data-type="monthly"]');
                    if (!row || e.target.closest('.lumpsum-btn')) return;
                    const currentlyActive = document.querySelector('.lumpsum-active');
                    if (currentlyActive && currentlyActive !== row) {
                        currentlyActive.classList.remove('lumpsum-active');
                    }
                    row.classList.toggle('lumpsum-active');
                });
                document.addEventListener('click', (e) => {
                    const activeRow = document.querySelector('.lumpsum-active');
                    if (activeRow && !activeRow.contains(e.target)) {
                        activeRow.classList.remove('lumpsum-active');
                    }
                });
            } else {
                document.body.classList.add('desktop-device');
            }

            // --- Initial Load ---
            window.addEventListener('load', async () => {
                setupPWA();
                userCurrency = await getUserCurrency();
                const currencySymbol = formatCurrency(0).replace(/[\d\.\s,]/g, '');
                loanAmountCurrencySymbolEl.textContent = currencySymbol;
                loadState();
                loadFromURL();
                renderTabs();
                loadActiveTabDataIntoUI();
            });
        }
    </script>
</body>
</html>
